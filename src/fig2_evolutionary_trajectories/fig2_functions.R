# libraries and functions -------------------------------------------------
library(docstring)
library(tidyverse)
library(data.table)
library(foreach)
library(doParallel)
library(parallel)
nr_cores <- detectCores() - 1
options(scipen = 999)

source('src/utility/readNumpyByTime.R') #utility file
source('src/utility/computeCoordinates.R') #utility file
source('src/utility/readGridLineage.R')  # utility function to read deprecated grid lineage files
source('src/utility/readSpeciesCounts.R')

# parameters ----------------------------------------------------------
gridwidth <- 45
tmax <- 1000000
stepsize <- 5000                                    # Reduce read interval for grid lineage data. Every 5000 time steps is reasonable. Cannot go lower than lineage_X.csv save interval.
t_plot <- seq(100000, 1000000, by = 100000)         # grid snapshot time points
sq <- seq(0, tmax, by = 250)                        # for subsampling lineage marker frequency plot


plotSim <- function(prot_rds, species_rds, cols = c(colour1, colour2))  {
  #' @title Make 3 ggplot2 objects for a simulation
  #' @description Main function to call. This function takes the processed proteome 
  #' and species_counts data from a single simulation, and plots lineage frequencies over time, 
  #' snapshots of lineage makers on the grid, and a PCA of single-cell proteomes. 
  #' For clarity you can provide two optional hex colours, to make sure that if two 
  #' lineages survive they have contrasting colours.
  #' @param prot_rds processed proteome data (generated by readFig2data.R)
  #' @param species_rds processed species_counts data (generated by readFig2data.R)
  #' @param cols a list of two optional hex colour for first and second of two surviving lineage markers
  #' @return a list of 3 ggplot2 objects:
  #' \item{$lineage:}{lineage marker frequencies vs time}
  #' \item{$grid:}{snapshots of lineage marker frequences on the grid for 10 time points along the simulation}
  #' \item{$PCA:}{pca of single-cell proteomes for 10 time points along the simulation}
  
  
  if(!file.exists(prot_rds)){
    stop('Error - prot_rds file does not exists')
  }
  if(!file.exists(species_rds)){
    stop('Error - species_rds file does not exists')
  }
  
  
  # functions ---------------------------------------------------------------
  
  makePCA <- function(df_prot)  {
    # returns PC 1-3 for plotting
    df_prot <- filter(df_prot, time %in% seq(0, 1000000, by = stepsize))
    cat('making PCA', '\n')
    # Normalise protein expression
    df.normalised <- df_prot
    df.normalised[, -c(1:4, 64)] <- df.normalised[, -c(1:4, 64)] / rowSums(df.normalised[, -c(1:4, 64)])
    
    labels <- c('time', 'lineage', 'gridpoint', 'x', 'y')
    
    for_pca <- df.normalised %>%
      filter(time != 0) %>%
      select(-labels) %>% # only select reactions
      filter_all(any_vars(. != 0))  # remove all zero rows (empty grid points)
    
    var0 <-
      unlist(lapply(for_pca, function(x)
        0 == var(if (is.factor(x))
          as.integer(x)
          else
            x)))
    for_pca <- for_pca[,!var0]
    pca <- prcomp(for_pca, center = TRUE, scale = TRUE)
    
    # calculate proportions of variance
    PoV <- pca$sdev ^ 2 / sum(pca$sdev ^ 2)
    PoV <- round(100 * PoV, digits = 2)
    
    labels <- df.normalised %>%
      filter(time != 0) %>%                                                                                    # why remove t=0?
      filter_at(vars(-c(time, lineage, x, y, gridpoint)),
                any_vars(. != 0)) %>%
      select(labels)
    
    # Reattach labels to the PCA data
    for_plot <-
      as.data.frame(cbind(labels, pca$x[, c(1:4)]))
    
    # for_plot$lineage  <-
    #   factor(for_plot$lineage, levels = -1:lin_max)
    
    return(for_plot)
  }
  
  
  plotPCA <- function(for_plot)  {
    
    cat('creating PCA plot', '\n')
    
    # figure out coordinates for text insert
    xmin <- for_plot %>% 
      filter(time %in% t_plot) %>% 
      filter(PC1 == min(.$PC1)) %>% 
      select(PC1) %>%
      unlist(.)
    
    ymin <- for_plot %>% 
      filter(time %in% t_plot) %>% 
      filter(PC2 == min(.$PC2)) %>%
      select(PC2) %>% 
      unlist(.)
    
    time_stamps <- data.frame(
      'labels' = paste('t =', seq(1:10)), 
      'time' = seq(100000, 1000000, by = 100000), 
      'x' = rep(xmin, 10), 
      'y' = rep(ymin, 10)
    )
    
    
    pca_lin <- for_plot %>%
      filter(time %in% t_plot) %>%
      ggplot(aes(x = PC1, y = PC2)) +
      geom_vline(xintercept = 0,
                 size = 0.5,
                 col = 'grey') +
      geom_hline(yintercept = 0,
                 size = 0.5,
                 col = 'grey') +
      facet_wrap(~ time, nrow = 1) +
      geom_point(aes(color = lineage), size = 1, alpha = 1) + # We can color mtab_4, mtab_16, or mtab_all
      theme_void() +
      scale_colour_manual(values = lin_col, drop = FALSE)  +
      theme(
        legend.position = 'none',
        aspect.ratio = 1,
        panel.border = element_rect(
          colour = "black",
          fill = NA,
          size = 0.5
        ),
        panel.spacing = unit(1.4, 'lines'),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        strip.text.y = element_text(size = 5),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_text(size = 7),
      ) +
      xlab('') +
      ylab('') + 
      geom_text(data = time_stamps,
                aes(x = x, y =y, label = labels, hjust = 'left', vjust = 'bottom')
      ) 
    
    return(pca_lin)
  }
  
  
  plotSpeciesCounts <- function(species_counts)  {
    
    cat('creating lineage marker plot', '\n')
    
    myplot <- species_counts %>%
      filter(time_point %in% sq) %>%
      ggplot(aes(x = time_point)) +
      geom_line(aes(y = fraction, col = lineage), size = 1) +
      theme_classic() +
      theme(
        legend.position = 'none',
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12)
      ) +
      ylab('Frequency') +
      xlab(expression(paste('Time (x', 10 ^ {
        5
      }, ' a.u.t.)'))) +
      scale_x_continuous(
        limits = c(0, tmax),
        expand = c(0, 0),
        breaks = c(0, t_plot),
        labels = function(x)
          x / 100000
      ) +
      scale_y_continuous(
        limits = c(0.005, 1.0),
        breaks = scales::pretty_breaks(n = 2), 
        expand = c(0,0)
      ) +
      scale_colour_manual(values = lin_col, drop = FALSE) 
    
    return(myplot)
  }
  
  
  plotGridLin <- function(df_prot)  {
    
    cat('creating lineage grid plot', '\n')
    
    myplot <-  df_prot %>%
      filter(time %in% t_plot) %>%
      ggplot() +
      geom_tile(aes(x = x, y = y, fill = lineage)) +
      theme_void() +
      facet_wrap(~ time, nrow = 1) +
      theme(
        legend.position = 'none',
        aspect.ratio = 1,
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        strip.text.y = element_text(size = 6),
        panel.spacing = unit(1.4, 'lines')
      ) + 
      scale_fill_manual(values = lin_col, drop = FALSE) +
      scale_x_continuous(expand=c(0,0)) +
      scale_y_continuous(expand=c(0,0))
    
    return(myplot)
  }
  
  source('src/utility/linColRainbow.R')
 
  

  # main function body ------------------------------------------------------
  
  cat('reading proteome data', '\n')
  df_prot <- readRDS(prot_rds)
  cat('reading lineage data data', '\n')
  species_counts <- readRDS(species_rds)
  
  lin_col <- linColRainbow(gridwidth^2, df_prot, cols) 
  
  plot_sp <- plotSpeciesCounts(species_counts) +  
    #ggtitle("Lineage tracking") + 
    theme(plot.margin = margin(1.4, 1, 0, 0, unit = 'lines'))
  
  plot_gl <- plotGridLin(df_prot) +
   # ggtitle("Grid Snapshots") + 
    theme(plot.margin = margin(0, 1, 0, 0, unit = 'lines'), 
          plot.title = element_text(vjust = 2.5)
    )
  
  
  df_pca <- makePCA(df_prot)
  plot_pca <- plotPCA(df_pca)
  plot_pca <- plot_pca +
    #ggtitle("PCA of single-cell proteomes (one dot = one cell)") +
    theme(plot.margin = margin(0, 1, 0, 0, unit = 'lines'),
          plot.title = element_text(vjust = 2.5)
    )
  
  return(list('lineage' = plot_sp, 'grid' = plot_gl, 'pca' = plot_pca))
  
}
